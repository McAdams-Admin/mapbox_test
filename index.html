<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapbox Map Starter – Improved</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root {
      --panel-bg: rgba(255, 255, 255, 0.95);
      --accent: #007cbf;
      --accent-hover: #005a8b;
      --text: #333;
      --muted: #666;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      --radius: 8px;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map { height: 100vh; width: 100%; }

    .map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: var(--panel-bg);
      padding: 12px;
      border-radius: var(--radius);
      font-size: 14px;
      box-shadow: var(--shadow);
      z-index: 1;
    }

    .map-overlay h3 { margin: 0 0 10px 0; color: var(--text); }

    button {
      margin: 2px;
      padding: 6px 10px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    button:hover { background: var(--accent-hover); }

    input[type="text"] {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 12px;
      width: 100%;
      box-sizing: border-box;
    }

    /* Simple toast for non-blocking notifications */
    .toast {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      z-index: 10001;
    }
    .toast.show { opacity: 0.93; }

    /* Panels */
    .panel { background: #fff; border: 1px solid #ddd; border-radius: var(--radius); box-shadow: var(--shadow); }
    .panel-header { padding: 10px 14px; font-weight: bold; font-size: 14px; color: var(--text); border-bottom: 1px solid #eee; user-select: none; cursor: pointer; }
    .panel-body { padding: 14px; min-width: 180px; }

    /* Mobile tweaks */
    @media (max-width: 640px) {
      .map-overlay { max-width: 70vw; }
    }
  </style>
</head>
<body>
  <div id="map" aria-label="Interactive map"></div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Main overlay (top left) -->
  <div class="map-overlay" aria-live="polite">
    <h3>Office Locations</h3>
    <div>
      <button onclick="flyToLocation([-78.6386, 35.7721])">Raleigh, NC</button>
      <button onclick="flyToLocation([-80.8414, 35.2271])">Charlotte, NC</button>
      <button onclick="flyToLocation([-80.2442, 36.0999])">Winston-Salem, NC</button>
      <button onclick="flyToLocation([-82.554, 35.5951])">Asheville, NC</button>
      <button onclick="flyToLocation([-78.8986, 35.994])">Durham, NC</button>
      <button onclick="flyToLocation([-82.394, 34.8526])">Greenville, SC</button>
      <button onclick="flyToLocation([-97.0403, 33.0462])">Lewisville, TX</button>
      <button onclick="flyToLocation([-81.3792, 28.5383])">Orlando, FL</button>
      <button onclick="flyToLocation([-82.4572, 27.9506])">Tampa, FL</button>
    </div>
    <div style="margin-top: 10px; font-size: 12px; color: var(--muted);">
      Zoom: <span id="zoom-level">15</span><br />
      Center: <span id="coordinates">Loading...</span>
    </div>
  </div>

  <!-- SEARCH PANEL (top right) -->
  <div class="panel" style="position: absolute; top: 10px; right: 10px; z-index: 10000; min-width: 260px;">
    <div class="panel-header" style="cursor: default;">Go to Location</div>
    <div class="panel-body">
      <input type="text" id="searchInput" placeholder="Enter address or lng,lat (e.g. -78.6382, 35.7796)" style="margin-bottom: 8px;" onkeypress="handleSearchKeyPress(event)" />
      <button onclick="searchLocation()" style="width: 100%; padding: 8px; font-size: 13px;">Search</button>
      <div style="font-size: 11px; color: var(--muted); line-height: 1.3; margin-top: 8px;">
        Examples:<br />• "1600 Pennsylvania Ave, Washington DC"<br />• "-78.6382, 35.7796" (lng,lat from Google Maps)
      </div>
    </div>
  </div>

  <!-- COLLAPSIBLE LAYER CONTROL PANEL (bottom left) -->
  <div class="panel" style="position: absolute; bottom: 20px; left: 20px; z-index: 10000;">
    <div class="panel-header" id="layerPanelHeader" role="button" tabindex="0" aria-expanded="false" aria-controls="layerPanelContent" onclick="toggleLayerPanel()" onkeypress="if(event.key==='Enter'||event.key===' ')toggleLayerPanel()">
      <span id="panelTitle">Map Layers</span>
      <span id="panelArrow" style="float: right;">▼</span>
    </div>
    <div id="layerPanelContent" class="panel-body" style="display: none;">
      <label style="display: block; margin: 8px 0; cursor: pointer; font-size: 13px;">
        <input type="checkbox" id="officeLayer" checked onchange="toggleLayer('offices')" style="margin-right: 8px;" />
        Office Buildings
      </label>
      <label style="display: block; margin: 8px 0; cursor: pointer; font-size: 13px;">
        <input type="checkbox" id="geojsonLayer" checked onchange="toggleLayer('geojson')" style="margin-right: 8px;" />
        GeoJSON Data
      </label>
      <label style="display: block; margin: 8px 0; cursor: pointer; font-size: 13px;">
        <input type="checkbox" id="homeLayer" checked onchange="toggleLayer('home')" style="margin-right: 8px;" />
        Home Location
      </label>
    </div>
  </div>

  <script>
    // Mapbox access token (consider scoping in your Mapbox account)
    mapboxgl.accessToken = 'pk.eyJ1Ijoic21pdGhtYjAyNDQiLCJhIjoiY21mNGV2YjhkMDRxdjJqcThhN3I3MDU3ZSJ9.jjhwaF_pzxV0Y1fUFC5wGA';

    // State
    let homeMarker = null;
    let officeMarkers = [];
    let searchMarker = null;
    let searching = false; // request gate for geocoder

    // Map init
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-78.644, 35.789],
      zoom: 15
    });

    // Controls
    map.addControl(new mapboxgl.NavigationControl());
    map.addControl(new mapboxgl.FullscreenControl());
    map.addControl(new mapboxgl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: true, showUserHeading: true }));
    map.addControl(new mapboxgl.Hash()); // shareable URL state

    // Helpers
    const toastEl = document.getElementById('toast');
    function showToast(msg, ms = 1600) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), ms);
    }

    function safeFlyTo(opts) {
      const go = () => map.flyTo({ duration: 1200, curve: 1.5, speed: 1.2, essential: true, ...opts });
      if (map.isStyleLoaded()) go(); else map.once('idle', go);
    }

    function updateInfo() {
      const center = map.getCenter();
      const zoom = map.getZoom();
      const decimals = Math.max(4, Math.min(7, Math.floor(zoom)));
      document.getElementById('coordinates').textContent = `${center.lng.toFixed(decimals)}, ${center.lat.toFixed(decimals)}`;
      document.getElementById('zoom-level').textContent = zoom.toFixed(1);
    }

    function flyToLocation(coordinates) {
      safeFlyTo({ center: coordinates, zoom: 12 });
    }

    function flyToCoordinates(coordinates, placeName) {
      if (searchMarker) searchMarker.remove();
      searchMarker = new mapboxgl.Marker({ color: '#28a745' })
        .setLngLat(coordinates)
        .setPopup(new mapboxgl.Popup().setHTML(`<h4>Search Result</h4><p>${placeName}</p>`))
        .addTo(map);
      safeFlyTo({ center: coordinates, zoom: 14 });
      console.log('Flew to:', placeName, coordinates);
    }

    function toggleLayer(layerType) {
      switch (layerType) {
        case 'offices': {
          const officeChecked = document.getElementById('officeLayer').checked;
          officeMarkers.forEach(m => (officeChecked ? m.addTo(map) : m.remove()));
          break;
        }
        case 'geojson': {
          const geojsonChecked = document.getElementById('geojsonLayer').checked;
          if (map.getLayer('geojson-points')) {
            map.setLayoutProperty('geojson-points', 'visibility', geojsonChecked ? 'visible' : 'none');
          }
          break;
        }
        case 'home': {
          const homeChecked = document.getElementById('homeLayer').checked;
          if (homeMarker) homeChecked ? homeMarker.addTo(map) : homeMarker.remove();
          break;
        }
      }
    }

    function toggleLayerPanel() {
      const header = document.getElementById('layerPanelHeader');
      const content = document.getElementById('layerPanelContent');
      const arrow = document.getElementById('panelArrow');
      const willShow = content.style.display === 'none';
      content.style.display = willShow ? 'block' : 'none';
      arrow.textContent = willShow ? '▲' : '▼';
      header.setAttribute('aria-expanded', String(willShow));
    }

    function handleSearchKeyPress(event) { if (event.key === 'Enter') searchLocation(); }

    async function searchLocation() {
      if (searching) return; // gate
      searching = true;
      try {
        const searchInput = document.getElementById('searchInput');
        const query = searchInput.value.trim();
        if (!query) { showToast('Enter an address or coordinates'); return; }

        // Coordinates pattern: allow spaces around comma
        const coordPattern = /^\s*-?\d+(?:\.\d+)?\s*,\s*-?\d+(?:\.\d+)?\s*$/;
        if (coordPattern.test(query)) {
          const [lng, lat] = query.split(',').map(s => parseFloat(s));
          if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            showToast('Invalid coordinates.');
          } else {
            flyToCoordinates([lng, lat], `${lng}, ${lat}`);
          }
          return;
        }

        // Mapbox Geocoding API with proximity + limit
        const center = map.getCenter();
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
          new URLSearchParams({
            access_token: mapboxgl.accessToken,
            limit: 5,
            proximity: `${center.lng},${center.lat}`
          });

        const response = await fetch(url);
        const data = await response.json();
        if (data.features && data.features.length > 0) {
          const feature = data.features[0];
          flyToCoordinates(feature.center, feature.place_name);
        } else {
          showToast('Location not found. Try a different address or use lng,lat.');
        }
      } catch (e) {
        console.error('Geocoding error:', e);
        showToast('Error searching for location.');
      } finally {
        searching = false;
      }
    }

    // Map load
    map.on('load', () => {
      console.log('Map loaded successfully');

      // Home marker
      homeMarker = new mapboxgl.Marker({ color: '#ff6b6b' })
        .setLngLat([-78.644, 35.789])
        .setPopup(new mapboxgl.Popup().setHTML('<h4>621 Hillsborough St</h4><p>Raleigh, NC - Home Location</p>'))
        .addTo(map);

      // Offices (DOM emoji markers)
      const offices = [
        { coords: [-78.6386, 35.7721], name: 'Raleigh Office', city: 'Raleigh, NC' },
        { coords: [-80.8414, 35.2271], name: 'Charlotte Office', city: 'Charlotte, NC' },
        { coords: [-80.2442, 36.0999], name: 'Winston-Salem Office', city: 'Winston-Salem, NC' },
        { coords: [-82.554, 35.5951], name: 'Asheville Office', city: 'Asheville, NC' },
        { coords: [-78.8986, 35.994], name: 'Durham Office', city: 'Durham, NC' },
        { coords: [-82.394, 34.8526], name: 'Greenville Office', city: 'Greenville, SC' },
        { coords: [-97.0403, 33.0462], name: 'Lewisville Office', city: 'Lewisville, TX' },
        { coords: [-81.3792, 28.5383], name: 'Orlando Office', city: 'Orlando, FL' },
        { coords: [-82.4572, 27.9506], name: 'Tampa Office', city: 'Tampa, FL' }
      ];

      offices.forEach((office) => {
        const buildingMarker = document.createElement('div');
        buildingMarker.innerHTML = '🏢';
        buildingMarker.style.fontSize = '24px';
        buildingMarker.style.cursor = 'pointer';
        buildingMarker.setAttribute('role', 'img');
        buildingMarker.setAttribute('aria-label', `${office.name}`);
        buildingMarker.setAttribute('tabindex', '0');

        const marker = new mapboxgl.Marker({ element: buildingMarker })
          .setLngLat(office.coords)
          .setPopup(new mapboxgl.Popup().setHTML(`<h4>${office.name}</h4><p>${office.city}</p>`))
          .addTo(map);

        officeMarkers.push(marker);
      });

      // Load GeoJSON
      loadGeoJSONData();
      updateInfo();
    });

    // Move events
    map.on('move', updateInfo);

    // GeoJSON loader with safer popups and geometry-type filter
    async function loadGeoJSONData() {
      try {
        console.log('Fetching GeoJSON…');
        // Fixed canonical raw GitHub URL (no refs/heads)
        const url = 'https://raw.githubusercontent.com/McAdams-Admin/mapbox_test/main/Request_Form_Output_Test.geojson';
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const geojsonData = await response.json();
        console.log('GeoJSON loaded:', geojsonData);

        const srcId = 'geojson-data';
        const lyrId = 'geojson-points';

        if (!map.getSource(srcId)) {
          map.addSource(srcId, { type: 'geojson', data: geojsonData });
        } else {
          map.getSource(srcId).setData(geojsonData);
        }

        const visible = document.getElementById('geojsonLayer').checked ? 'visible' : 'none';

        if (!map.getLayer(lyrId)) {
          map.addLayer({
            id: lyrId,
            type: 'circle',
            source: srcId,
            filter: ['==', ['geometry-type'], 'Point'],
            layout: { visibility: visible },
            paint: {
              'circle-radius': 8,
              'circle-color': '#3498db',
              'circle-stroke-color': '#fff',
              'circle-stroke-width': 2
            }
          });

          map.on('mouseenter', lyrId, () => (map.getCanvas().style.cursor = 'pointer'));
          map.on('mouseleave', lyrId, () => (map.getCanvas().style.cursor = ''));

          map.on('click', lyrId, (e) => {
            const props = e.features[0].properties || {};
            const container = document.createElement('div');
            for (const [k, v] of Object.entries(props)) {
              if (v == null) continue;
              const row = document.createElement('div');
              const kEl = document.createElement('strong');
              kEl.innerText = `${k}: `; // innerText prevents HTML injection
              const vEl = document.createElement('span');
              vEl.innerText = String(v);
              row.append(kEl, vEl);
              container.appendChild(row);
            }
            new mapboxgl.Popup().setLngLat(e.lngLat).setDOMContent(container).addTo(map);
          });
        }
      } catch (err) {
        console.error('Error loading GeoJSON:', err);
        showToast('Failed to load GeoJSON');
      }
    }
  </script>
</body>
</html>










